/*! Puppetglasses - v0.1.0 - 2015-03-16
* https://github.com/tosmi/puppetglasses
* Copyright (c) 2015 Toni Schmidbauer; Licensed GPLv3 */
window.puppetglassesConfig={},puppetglassesConfig.puppetdb_url="http://localhost:2080/v3";var PuppetglassesStatistics=function(){function a(){this.initStatisticsTableDone=!1,this.calculateStatistics=function(a){c["total-nodes"].value=a.length;for(var b in a){var d=new Date,e=new Date(a[b].catalog_timestamp);d-e>18e5?c["stale-nodes"].value++:c["active-nodes"].value++}},this.displayStatistics=function(){for(var a in c){var b="#"+a;$(b).text(c[a].value)}this.updateNodeChart()},this.updateNodeChart=function(){var a=[{value:c["active-nodes"].value,color:"#46BFBD",highlight:"#5AD3D1",label:c["active-nodes"].desc},{value:c["stale-nodes"].value,color:"#F7464A",highlight:"#FF5A5E",label:c["stale-nodes"].desc}],b=$("#node_chart").get(0).getContext("2d");new Chart(b).Doughnut(a)},this.updateNodeMetrics=function(){var a=puppetglassesConfig.puppetdb_url+"/nodes",b=this;$.get(a).done(function(a){b.calculateStatistics(a),b.displayStatistics()})},this.updateMetric=function(a){var d=this,e=puppetglassesConfig.puppetdb_url+"/metrics/mbean/"+encodeURIComponent(b+a);$.get(e).done(function(b){c[a].value=b.Value,d.displayStatistics()})},this.initStatisticsTable=function(){if(!this.initStatisticsTableDone){for(var a in c){var b="<tr><td>"+c[a].desc+"</td>";b+='<td id="'+a+'">'+c[a].value+"</td></tr>",$("#statistics_table tbody").append(b)}this.initStatisticsTableDone=!0}},this.collect=function(){this.updateNodeMetrics(),this.updateMetric("num-resources"),this.updateMetric("avg-resources-per-node"),this.updateMetric("pct-resource-dupes")}}var b="com.puppetlabs.puppetdb.query.population:type=default,name=",c={"total-nodes":{desc:"Total number of nodes",value:0},"active-nodes":{desc:"Number of active nodes",value:0},"stale-nodes":{desc:"Number of stale nodes",value:0},"num-resources":{desc:"Number of resources",value:0},"avg-resources-per-node":{desc:"Average number of resources per nodes",value:0},"pct-resource-dupes":{desc:"Percentage of resource duplications",value:0}};return a.prototype.run=function(){this.initStatisticsTable(),this.collect()},a}(),Puppetglasses=function(){"use strict";function a(){this.config=puppetglassesConfig,this.statistics=new PuppetglassesStatistics}function b(a,b){for(var c=[],d=0;d<a.length;d++)c.push(a[d].name);b(c)}function c(a){e.row.add([a.type,a.title,d(a.parameters)])}function d(a){var b="";for(var c in a)a.hasOwnProperty(c)&&(b+=c+"=>"+a[c]+"\n");return b}a.prototype.findNodes=function(a,c){var d=this.config.puppetdb_url+'/nodes?query=["~","name","'+a.term+'"]';$.getJSON(d).done(function(a){b(a,c)})},a.prototype.findResources=function(){var a=$("#hostname").val(),b=this.config.puppetdb_url+"/nodes/"+a+"/resources",c=this;$.get(b).done(function(a){c.displayResources(a)})},a.prototype.displayResources=function(a){e.clear(),a.map(c),e.search("").columns().search("").draw(),this.addTooltips(),$("#resources").show()},a.prototype.addTooltips=function(){e.column(2).visible(!0),$("#resource_table tbody tr").each(function(){var a=$("td",this)[2],b=$(a).text();this.setAttribute("title",b)}),e.column(2).visible(!1)},a.prototype.showStatistics=function(){var a=this;$("#navbar_statistics").addClass("active"),$("#navbar_resources").removeClass("active"),$("#puppetglasses_resources").hide(),$("#puppetglasses_statistics").show(0,function(){a.statistics.run()})},a.prototype.showResources=function(){$("#navbar_statistics").removeClass("active"),$("#navbar_resources").addClass("active"),$("#puppetglasses_resources").show(),$("#puppetglasses_statistics").hide()};var e=$("#resource_table").DataTable({search:{caseInsensitive:!1},columnDefs:[{targets:2,searchable:!1}]});return a}();$(document).ready(function(){var a=new Puppetglasses;$("#hostname").autocomplete({source:function(b,c){a.findNodes(b,c)}}),$("#search").click(function(){a.findResources()}),$("#navbar_statistics").click(function(){a.showStatistics()}),$("#navbar_resources").click(function(){a.showResources()}),$("#resources").hide(),$("#puppetglasses_statistics").hide(),$("#resource_table").on("draw.dt",function(){a.addTooltips()})});